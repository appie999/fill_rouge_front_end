<app-vavbar></app-vavbar>
<!-- Mobile menu toggle -->
<button class="mobile-menu-toggle" (click)="toggleMobileMenu()">
  <span>‚ò∞</span>
</button>

<!-- Mobile overlay -->
<div class="overlay" [class.show]="menuOpen" (click)="closeMobileMenu()"></div>

<div class="layout">
  <!-- Sidebar -->
  <aside class="sidebar" [class.open]="menuOpen">
    <div class="brand">Clinic <b>IQ</b></div>

    <nav class="menu">
      <a class="menu-item active" routerLink="/doctor/dashboard" (click)="closeMobileMenu()">
        <span class="mi">üìä</span><span class="label">Tableau de Bord</span>
      </a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="content">
    <!-- Topbar -->
    <header class="topbar">
      <div class="d-md-none"></div>
      <div class="dashboard-header">
        <h2>Bienvenue, Dr. {{ username }} !</h2>
      </div>
    </header>

    <!-- KPIs -->
    <section class="kpi-row">
      <article class="mini-card">
        <div class="mini-head"><span>Rendez‚Äëvous Aujourd'hui</span><span class="ico"></span></div>
        <div class="mini-val">{{ todayAppointments }}</div>
      </article>
      <article class="mini-card">
        <div class="mini-head"><span>Demandes en Attente</span><span class="ico"></span></div>
        <div class="mini-val">{{ pendingAppointments }}</div>
      </article>
      <article class="mini-card">
        <div class="mini-head"><span>Nouveaux R√©sultats Labo</span><span class="ico"></span></div>
        <div class="mini-val">{{ newLabResults }}</div>
      </article>
    </section>

    <!-- Success/Error Messages -->
    <div *ngIf="successMessage" class="alert alert-success text-center border-0 shadow-sm mb-3">
      üéâ {{ successMessage }}
    </div>
    <div *ngIf="error" class="alert alert-danger text-center border-0 shadow-sm mb-3">
      ‚ùå {{ error }}
    </div>

    <!-- Upcoming appointments -->
    <section class="card">
      <div class="card-title">Prochains Rendez‚Äëvous d'Aujourd'hui</div>
      <div *ngIf="loading" class="text-center p-3">
        <p>Chargement des rendez-vous...</p>
      </div>
      <div *ngIf="error" class="text-danger p-3">
        <p>{{ error }}</p>
      </div>
      <div class="table-wrapper" *ngIf="!loading && !error">
        <div class="table">
          <div class="thead">
            <div>HEURE</div><div>PATIENT</div><div>MOTIF</div><div>STATUT</div><div>ACTIONS</div><div>NOTES</div>
          </div>
          <div class="tbody">
            <div class="tr" *ngFor="let appointment of appointments">
              <div data-label="Heure">{{ formatDate(appointment.date) }}</div>
              <div data-label="Patient">
                <strong>{{ appointment.patientName || ('Patient ' + appointment.patientId) }}</strong>
                <br><small class="text-muted">{{ appointment.patientEmail || '' }}</small>
              </div>
              <div data-label="Motif">Consultation</div>
              <div data-label="Statut"><span class="pill" [ngClass]="getStatusClass(appointment.status)">{{ appointment.status }}</span></div>
              <div data-label="Actions" class="actions">
                <a href="#" (click)="viewPatientDetails(appointment.patientName || ('Patient ' + appointment.patientId))">Dossier</a> ‚Ä¢ 
                <a href="#" (click)="addConsultationNotes('appointment' + appointment.id)">Consultation</a>
              </div>
              <div data-label="Notes" class="actions">
                <a href="#">Ajouter Notes</a>
              </div>
            </div>
            <div class="tr" *ngIf="appointments.length === 0">
              <div colspan="6" class="text-center text-muted p-3">Aucun rendez-vous confirm√© aujourd'hui</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Pending appointment requests -->
    <section class="card">
      <div class="card-title">üìç Demandes de Rendez‚Äëvous en Attente</div>
      
      <!-- Debug Info for Dr. Farid -->
      <div *ngIf="username && username.toLowerCase().includes('farid')" class="alert alert-info mb-3">
        üîç <strong>Mode Debug pour Dr. Farid:</strong>
        <br>‚Ä¢ V√©rifiez les logs de la console (F12)
        <br>‚Ä¢ V√©rifiez les logs du backend
        <br>‚Ä¢ Total demandes: {{ pendingRequests.length }}
      </div>
      
      <div class="table-wrapper" *ngIf="pendingRequests.length > 0; else noPendingRequests">
        <div class="table">
          <div class="thead">
            <div>DATE/HEURE</div><div>PATIENT</div><div>MOTIF</div><div>CONTACT</div><div>D√âCISION</div><div>DEBUG</div>
          </div>
          <div class="tbody">
            <div class="tr" *ngFor="let request of pendingRequests; let i = index">
              <div data-label="Date/Heure">
                <strong>{{ request.dateTime }}</strong>
              </div>
              <div data-label="Patient">
                <strong>{{ request.patient }}</strong>
                <br><small class="text-muted">ID: {{ request.appointmentData.patientId }}</small>
              </div>
              <div data-label="Motif">
                <span class="badge bg-info">{{ request.reason }}</span>
              </div>
              <div data-label="Contact">
                <small class="text-muted">{{ request.patientEmail || 'Email non disponible' }}</small>
                <br><a href="#" (click)="viewPatientDetails(request.patient)" class="btn btn-sm btn-outline-info">Voir Dossier</a>
              </div>
              <div data-label="D√©cision" class="actions">
                <button class="btn btn-sm btn-success me-2" (click)="approveAppointment(request.appointmentData.id)">
                  ‚úÖ Accepter
                </button>
                <button class="btn btn-sm btn-danger" (click)="rejectAppointment(request.appointmentData.id)">
                  ‚ùå Refuser
                </button>
              </div>
              <div data-label="Debug" *ngIf="username && username.toLowerCase().includes('farid')">
                <small class="text-muted">
                  Apt: {{ request.appointmentData.id }}<br>
                  Dr: {{ request.appointmentData.doctorId }}
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
      <ng-template #noPendingRequests>
        <div class="text-center p-4">
          <div class="h5 text-muted">üéâ Aucune demande en attente</div>
          <p class="text-muted">Toutes vos demandes de rendez-vous ont √©t√© trait√©es!</p>
          
          <!-- Enhanced debug info when no requests found -->
          <div *ngIf="username && username.toLowerCase().includes('farid')" class="alert alert-warning mt-3">
            <strong>Debug Dr. Farid:</strong> Aucune demande trouv√©e.<br>
            <small>V√©rifiez que:</small>
            <ul class="text-start mt-2">
              <li>Des patients ont r√©serv√© des rendez-vous avec Dr. Farid</li>
              <li>L'email d'authentification correspond √† celui en base</li>
              <li>Les rendez-vous sont en statut PENDING</li>
            </ul>
          </div>
        </div>
      </ng-template>
    </section>
  </main>
</div>